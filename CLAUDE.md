# UI Engine - Claude Instructions

## Project Configuration

- **Package Manager**: Use `bun` instead of `npm` or `yarn` for all JavaScript dependencies
- **Tailwind Version**: Tailwind CSS 4 (configuration via CSS, not JS config files)
- **Asset Pipeline**: Multi-version support (Propshaft for Rails 8, Sprockets for Rails 6/7)
- **Live Reload**: Hotwire Spark for instant feedback during development

## Important: Asset Architecture

**The engine DOES NOT contain Tailwind configuration.** It only provides:
- CSS variables in `app/assets/stylesheets/ui/application.css`
- JavaScript modules in `app/javascript/ui/`
- Views and components

**Each application (including dummy app) configures its own Tailwind CSS:**
- The host app creates `app/assets/stylesheets/application.tailwind.css`
- The host app imports engine variables: `@import "ui/application.css"`
- The host app configures `@source` paths to scan engine files for Tailwind classes
- The host app compiles its own CSS to `app/assets/builds/application.css`

## JavaScript Integration: Two Approaches

This engine supports **two different approaches** for JavaScript integration:

### 1. Importmaps (Default - Rails 8)
**Best for**: Simple apps, Rails 8 default, zero-build JavaScript

- **How it works**: Engine JavaScript is loaded via importmap pins
- **Layout**: Uses `<%= javascript_importmap_tags %>`
- **No build step required** for JavaScript
- **Engine initializer**: Automatically draws engine's importmap config
- **Test route**: `http://localhost:4000/ui/`

### 2. Bundlers (jsbundling-rails + Bun)
**Best for**: Complex apps, tree-shaking, npm ecosystem integration

- **How it works**: Engine installed as npm package `@ui/engine`, bundled with Bun
- **Layout**: Uses `<%= javascript_include_tag "bundled", type: "module" %>`
- **Build step**: `bun build` compiles JavaScript to `app/assets/builds/bundled.js`
- **Installation**: `bun link @ui/engine` (development) or `bun add @ui/engine` (production)
- **Test route**: `http://localhost:4000/bundled`

Both approaches work simultaneously in the dummy app for testing!

## Development Commands

```bash
# Dummy app commands (from test/dummy directory)
cd test/dummy

# Install dependencies
bun install

# Link engine locally for bundler testing
cd .. && bun link && cd test/dummy && bun link @ui/engine

# Build CSS (one-time)
bun run build:css

# Build bundled JS (one-time)
bun run build:js

# Watch mode for CSS
bun run build:css:watch

# Watch mode for bundled JS
bun run build:js:watch

# Run dummy app with Rails + CSS + JS watch (all processes)
bin/dev
```

### Procfile.dev (test/dummy)
```
web: bin/rails server -p 4000
css: bun run build:css:watch
js: bun run build:js:watch
```

## Asset Structure

### Engine Assets (shipped with gem)
- **CSS Variables**: `app/assets/stylesheets/ui/application.css` - Base CSS variables only
- **JavaScript**: `app/javascript/ui/index.js` - JS entry point
- **Views**: `app/views/ui/` - Engine views (scanned by host app's Tailwind)
- **Components**: `app/components/ui/` - Ruby components (scanned by host app's Tailwind)

### Host App Assets (created by generator or manually)

**For Importmaps approach:**
- **Tailwind Config**: `app/assets/stylesheets/application.tailwind.css` - Tailwind 4 config with `@import`, `@source`, `@theme`
- **Compiled CSS**: `app/assets/builds/application.css` - Generated file (git-ignored)
- **Layout**: Uses `<%= javascript_importmap_tags %>`
- **Importmap Config**: `config/importmap.rb` - Pins for Turbo, Stimulus, etc.

**For Bundlers approach (jsbundling-rails):**
- **Same Tailwind Config** as above
- **JavaScript Entry**: `app/javascript/bundled.js` - Imports `@ui/engine`
- **Bundled Output**: `app/assets/builds/bundled.js` - Generated by Bun (git-ignored)
- **Layout**: Uses `<%= javascript_include_tag "bundled", type: "module" %>`
- **Package.json**: Contains `@ui/engine` dependency and build scripts

## Testing Different Rails Versions

This engine supports:
- **Rails 8 with Propshaft + Importmaps** (default, zero-build JS)
- **Rails 8 with Propshaft + jsbundling-rails** (Bun/esbuild/webpack)
- **Rails 7/6 with Sprockets** (legacy support)

The engine automatically detects the asset pipeline and configures itself accordingly.

## Publishing Engine as NPM Package

The engine's `package.json` is configured for npm publishing:

```json
{
  "name": "@ui/engine",
  "type": "module",
  "main": "app/javascript/ui/index.js",
  "exports": {
    ".": "./app/javascript/ui/index.js",
    "./styles": "./app/assets/stylesheets/ui/application.css"
  }
}
```

**To publish:**
```bash
# Update version in package.json
bun version patch|minor|major

# Publish to npm (update @ui/engine to your npm scope)
npm publish --access public
```

**Host apps can then install:**
```bash
bun add @ui/engine
# or
npm install @ui/engine
```

## Hotwire Spark - Live Reload

The dummy app is configured with **Hotwire Spark** for instant live reload during development.

### Configuration (test/dummy/config/environments/development.rb)

```ruby
# Configure Hotwire Spark for live reload
# Watch engine HTML files (views and components)
config.hotwire.spark.html_paths << Rails.root.join("../../app/views/ui")
config.hotwire.spark.html_paths << Rails.root.join("../../app/components/ui") if Rails.root.join("../../app/components/ui").exist?

# Watch engine CSS files
config.hotwire.spark.css_paths << Rails.root.join("../../app/assets/stylesheets/ui")

# Watch dummy app CSS
config.hotwire.spark.css_paths << Rails.root.join("app/assets/stylesheets")

# Watch engine JavaScript files
config.hotwire.spark.stimulus_paths << Rails.root.join("../../app/javascript/ui")

# Watch dummy app JavaScript
config.hotwire.spark.stimulus_paths << Rails.root.join("app/javascript")
```

### Routes (test/dummy/config/routes.rb)

```ruby
mount Hotwire::Spark::Engine => "/spark" if Rails.env.development?
```

**What gets live reloaded:**
- ✅ Engine views (`.erb`, `.html.erb`)
- ✅ Engine CSS files
- ✅ Engine JavaScript files
- ✅ Dummy app views, CSS, and JavaScript

Simply run `bin/dev` and edit any watched file - changes reload automatically!

## Component Development Best Practices

### CSS and Styling Rules

**ALWAYS use Tailwind utility classes. NEVER write custom CSS or inline styles.**

- ❌ **NEVER**: `style="height: 300px"` or custom CSS in `<style>` tags
- ✅ **ALWAYS**: Use Tailwind classes like `h-[300px]` or arbitrary values `transition-[height]`

### CSS Variables in Tailwind 4

When adding CSS variables that Tailwind needs to use:

1. **Define in `:root`** (for browser access):
   ```css
   :root {
     --duration-accordion: 300ms;
     --ease-accordion: cubic-bezier(0.87, 0, 0.13, 1);
   }
   ```

2. **Define in `@theme`** (for Tailwind class generation):
   ```css
   @theme {
     --duration-accordion: 300ms;
     --ease-accordion: cubic-bezier(0.87, 0, 0.13, 1);
   }
   ```

3. **Use the variable** in component classes to trigger generation:
   ```ruby
   "transition-[height] duration-[var(--duration-accordion)] ease-[var(--ease-accordion)]"
   ```

**Important**: Tailwind 4 only generates utility classes for classes that are **actually used** in scanned files. If a variable exists in `@theme` but isn't used anywhere, no utility class will be generated.

### Testing CSS Variable Generation

After adding new variables, verify they're being generated:

```bash
# Rebuild CSS
bun run build:css

# Check if variable is in :root
grep "your-variable" ./test/dummy/app/assets/builds/application.css

# Check if utility class was generated
grep "your-utility-class" ./test/dummy/app/assets/builds/application.css
```

### Reference Implementation

When implementing components, **always reference shadcn/ui and Radix UI**:

1. **Visual Reference**: https://ui.shadcn.com/docs/components/[component]
2. **Behavior Reference**: https://www.radix-ui.com/primitives/docs/components/[component]
3. **Source Code**: https://github.com/radix-ui/primitives/tree/main/packages/react/[component]/src

**Use browser dev tools** to inspect shadcn examples and extract:
- Exact CSS classes used
- HTML structure and nesting
- ARIA attributes
- Data attributes for state management
- Animation timings and easing functions

### Component Migration Checklist

When migrating a component from shadcn/Radix:

1. ✅ Compare HTML structure with shadcn example
2. ✅ Extract all CSS classes from browser dev tools
3. ✅ Verify animations match (duration, easing, properties)
4. ✅ Check ARIA attributes for accessibility
5. ✅ Test with Playwright to compare visual appearance
6. ✅ Ensure all CSS variables are in both `:root` and `@theme`
7. ✅ Verify Tailwind generates all needed utility classes

## Generator Usage

```bash
rails generate ui:install
```

This creates:
- `app/assets/stylesheets/application.tailwind.css`
- `app/assets/builds/.keep`
- `package.json` (if not exists)
- `Procfile.dev` (if not exists)
- Updates `.gitignore`
- Configures importmap (if using importmaps)
