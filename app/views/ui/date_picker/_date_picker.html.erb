<%#
  DatePicker component (ERB)
  A date picker that combines a popover trigger with a calendar.

  @param mode [Symbol/String] "single", "range", or "multiple" selection mode (default: :single)
  @param selected [Date, Range, Array] initially selected date(s)
  @param locale [String] BCP 47 locale tag for formatting (default: "en-US")
  @param format [String] Date format style: "short", "medium", "long", "full" (default: "long")
  @param placeholder [String] Placeholder text when no date selected (default: "Select date")
  @param range_placeholder [String] Placeholder for range mode (default: "Select date range")
  @param close_on_select [Boolean] Close popover after selection (default: true)
  @param name [String] Form field name for hidden input
  @param label [String] Label text for the date picker
  @param label_for [String] ID to associate label with input
  @param show_dropdowns [Boolean] Show month/year dropdowns in calendar (default: false)
  @param min_date [Date] Minimum selectable date
  @param max_date [Date] Maximum selectable date
  @param disabled_dates [Array<Date>] Dates that cannot be selected
  @param classes [String] Additional CSS classes
  @param attributes [Hash] Additional HTML attributes

  Basic usage:
    render "ui/date_picker/date_picker" do
      render "ui/date_picker/date_picker_trigger", placeholder: "Pick a date"
    end

  With form field:
    render "ui/date_picker/date_picker", name: "user[birth_date]", label: "Date of Birth" do
      render "ui/date_picker/date_picker_trigger"
    end
%>
<%
  @mode = local_assigns.fetch(:mode, :single)
  @selected = local_assigns.fetch(:selected, nil)
  @locale = local_assigns.fetch(:locale, "en-US")
  @format = local_assigns.fetch(:format, "long")
  @placeholder = local_assigns.fetch(:placeholder, "Select date")
  @range_placeholder = local_assigns.fetch(:range_placeholder, "Select date range")
  @close_on_select = local_assigns.key?(:close_on_select) ? local_assigns[:close_on_select] : true
  @name = local_assigns.fetch(:name, nil)
  @label = local_assigns.fetch(:label, nil)
  @label_for = local_assigns.fetch(:label_for, nil)

  # Calendar options (passed through)
  @show_dropdowns = local_assigns.fetch(:show_dropdowns, false)
  @min_date = local_assigns.fetch(:min_date, nil)
  @max_date = local_assigns.fetch(:max_date, nil)
  @disabled_dates = local_assigns.fetch(:disabled_dates, [])
  @number_of_months = local_assigns.fetch(:number_of_months, 1)
  @week_starts_on = local_assigns.fetch(:week_starts_on, 0)

  @classes = local_assigns.fetch(:classes, "")
  @attributes = local_assigns.fetch(:attributes, {})

  extend ::UI::DatePicker::DatePickerBehavior

  all_attributes = date_picker_html_attributes.deep_merge(@attributes.except(:data))
  if @attributes[:data]
    all_attributes[:data] = all_attributes[:data].merge(@attributes[:data])
  end
-%>
<%= content_tag :div, all_attributes do %>
  <% if @label %>
    <%= render "ui/label/label", content: @label, for: @label_for, classes: "px-1" %>
  <% end %>

  <%= render "ui/popover/popover", trigger: "click", placement: "bottom-start", offset: 4 do %>
    <%= yield %>

    <%= render "ui/popover/popover_content", classes: "w-auto overflow-hidden p-0" do %>
      <%= render "ui/calendar/calendar",
        mode: @mode,
        selected: @selected,
        locale: @locale,
        show_dropdowns: @show_dropdowns,
        min_date: @min_date,
        max_date: @max_date,
        disabled_dates: @disabled_dates,
        number_of_months: @number_of_months,
        week_starts_on: @week_starts_on,
        attributes: {
          data: {
            action: "ui--calendar:select->ui--datepicker#handleSelect"
          }
        }
      %>
    <% end %>
  <% end %>

  <% if @name %>
    <%= hidden_field_tag @name, selected_value, data: { ui__datepicker_target: "hiddenInput" } %>
  <% end %>
<% end %>
